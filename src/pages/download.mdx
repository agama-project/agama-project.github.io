import React, {useEffect, useState} from "react";
import xbytes from "xbytes";

import Link from "@docusaurus/Link";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

export const HelpLinks = ({ dvdHelp, usbHelp }) => (
  <div className="flex-container">
    <Link className="button button--primary" to={usbHelp}>
      Prepare a USB stick
    </Link>
    <Link className="button button--secondary" to={dvdHelp}>
      Burn a DVD
    </Link>
  </div>
);

{/* architecture header */}
export const ArchHeader = ({arch}) => <h3 id={`download-${arch}`}>{arch}</h3>;

{/* progress indicator */}
export const Loading = () => <p><em>Loading data...</em></p>;

{/* show a download link for a specified architecture */}
{/*  arch - the architecture name */}
{/*  files - data downloaded from OBS */}
export const DownloadLink = ({arch, files}) => {
  const file = files?.find(f => f.name.includes(arch));
  // base URL where the images are located
  const url = "https://download.opensuse.org/repositories/systemsmanagement:/Agama:/Devel/images/iso";

  return (
    <p>
      { /* download failed or missing data, display a generic static link without version */ }
      { !file &&
        <a href={`${url}/agama-installer.${arch}-openSUSE.iso`}>
          {`agama-installer.${arch}-openSUSE.iso`}
        </a>
      }
      { /* found matching image, display the versioned link and the image size */ }
      { file &&
        <>
          <a href={`${url}/${file.name}`}>
            {file.name}
          </a>
          { " (" }
          { /* one decimal place in the formatted size */}
          { xbytes(file.size, {fixed: 1}) }
          { ")" }
        </>
      }
      <br/>
      { !file &&
        <a href={`${url}/agama-installer.${arch}-openSUSE.iso.sha256`}>
          {`agama-installer.${arch}-openSUSE.iso.sha256`}
        </a>
      }
      { file &&
        <a href={`${url}/${file.name}.sha256`}>
          {`${file.name}.sha256`}
        </a>
      }
    </p>
  );
};

export const DownloadLinks = () => {
  // this variable contains the downloaded data from OBS
  //   undefined => data not loaded yet (display loading status)
  //   empty array => download failed or timed out or invalid data was returned
  //     (display generic unversioned links)
  const [files, setFiles] = useState();

  // unfortunately the direct download from the download.opensuse.org server does not work because
  // of the CORS policy, as a workaround use a CORS proxy deployed in the Google Firebase cloud for
  // downloading the data
  // see https://github.com/lslezak/cors-proxy/blob/main/functions/index.js
  // it just forwards the data from
  // https://download.opensuse.org/repositories/systemsmanagement:/Agama:/Devel/images/iso/?jsontable
  const corsProxy = "https://corsproxy-kcuoblmnuq-uc.a.run.app/";

  const loadData = () => {
    // if the data is not loaded in 2 seconds then display the generic links
    const timer = setTimeout(() => !files && setFiles([]), 2000);
    // download data from the OBS server
    fetch(corsProxy)
      .then(response => response.json())
      .then(json => {
        // keep only the openSUSE ISO image data, we do not care about the rest
        const data = json.data.filter(f => f.name.match(/^agama-installer\..*-openSUSE-Build.*\.iso$/))
        console.log("Downloaded OBS data:", data);
        setFiles(data);
      })
      .catch(err => {
        console.error("OBS download failed:", err);
        setFiles([]);
      })
      .finally(() => clearTimeout(timer));
  };

  useEffect(() => {
    loadData();
    // refresh every 15 minutes to have up to date links when the page is displayed for a long time
    const timer = setInterval(() => loadData(), 15*60*1000);
    return () => clearInterval(timer);
  }, []);

  return (
    <>
      <ArchHeader arch="x86_64" />
      { files ? <DownloadLink arch="x86_64" files={files}/> : <Loading /> }
      <ArchHeader arch="aarch64" />
      { files ? <DownloadLink arch="aarch64" files={files}/> : <Loading /> }
      <ArchHeader arch="ppc64le" />
      { files ? <DownloadLink arch="ppc64le" files={files}/> : <Loading /> }
      <ArchHeader arch="s390x" />
      { files ? <DownloadLink arch="s390x" files={files}/> : <Loading /> }
    </>
  );
};

# Official Agama Live ISO

Agama **is a multi-product installer**. It means that you can install different distributions using
a single medium. In close collaboration with the openSUSE project, the current image allows
installing [openSUSE Tumbleweed](https://www.opensuse.org/#Tumbleweed), [openSUSE Leap 16.0
](https://www.opensuse.org/#Leap), [openSUSE Micro OS](https://get.opensuse.org/microos/) and
[openSUSE Slowroll](https://en.opensuse.org/Portal:Slowroll) (experimental).

## Download the Agama Live ISO

Download the ISO image that matches the architecture of your machine. The `*.sha256` files contain a
checksum of the ISO file so you can verify that the image was downloaded correctly, see the
instructions below.

<DownloadLinks />

### Verifying the downloaded image

You might want to check whether the ISO was correctly downloaded. If that's the case, you can
download the checksum file too and use the
[sha256sum](https://manpages.opensuse.org/Tumbleweed/coreutils-doc/sha256sum.1.en.html) command:

```shell
sha256sum -c agama-installer.x86_64-openSUSE.iso.sha256
```

Obviously, use the checksum that corresponds to the downloaded ISO.

## Create a bootable medium

Once you have the ISO, it is time to [create a bootable USB
stick](https://en.opensuse.org/SDB:Live_USB_stick) (recommended) or [burn a
DVD](https://en.opensuse.org/SDB:Download_help#Using_Linux).

<Tabs className="unique-tabs">
  <TabItem value="linux" label="From Linux" default>
    <HelpLinks
      dvdHelp="https://en.opensuse.org/SDB:Download_help#Using_Linux"
      usbHelp="https://en.opensuse.org/SDB:Live_USB_stick"
    />
  </TabItem>
  <TabItem value="windows" label="From Windows" default>
    <HelpLinks
      dvdHelp="https://en.opensuse.org/SDB:Download_help#Using_Microsoft_Windows"
      usbHelp="https://en.opensuse.org/SDB:Create_a_Live_USB_stick_using_Windows"
    />
  </TabItem>
  <TabItem value="osx" label="From OS X" default>
    <HelpLinks
      dvdHelp="https://en.opensuse.org/SDB:Download_help#Using_MacOS_X_.2810.3_and_above.29"
      usbHelp="https://en.opensuse.org/SDB:Create_a_Live_USB_stick_using_Mac_OS_x"
    />
  </TabItem>
</Tabs>

## Start the installation

Starting the system using the bootable medium should take you to the product selection screen.
Please, bear in mind that it may take a few seconds. You might want to review the [user's
documentation](docs/user) to know how to continue from here.
